#!/bin/bash
#
# Create user in SQL-Ledger
#
# Created by Karoly Molnar <kmolnar@cirruscomputing.com>
#
# Copyright (c) 1996-2011 Free Open Source Solutions Inc.
# All Rights Reserved
#
# Free Open Source Solutions Inc. owns and reserves all rights, title,
# and interest in and to this software in both machine and human
# readable forms.
#
# Customers say that they don't want all emplyees to have access to the accounts, so we do not fill in the employeelogin field.
# RWL Feb 2013
#
# Reverse the above, all employees now Will have access to the accounts, so we do fill in the employeelogin field.
# We have upgraded to v 3.0.4 of SQL-ledger, with its changed POST api.
# Regular employees will have only the preferences, version, and logout screens until admin grants them more.
# RWL Feb 2014
#

# Parameters set at deploy time
DB_PASSWORD_SQL_LEDGER="[-DB_PASSWORD_SQL_LEDGER-]"
SQL_LEDGER_PASSWORD_ADMIN="[-SQL_LEDGER_PASSWORD_ADMIN-]"
COMPANY_NAME="[-ORG_FULL_NAME-]"
LDAP_PASSWORD_LIBNSS="[-LDAP_PASSWORD_LIBNSS-]"

# Variables
BIN_FOLDER=${0%/*}
AWK_FOLDER=$BIN_FOLDER/awk
DOMAIN=$(hostname -d)
LDAP_BASE=$(awk '$1 ~ "^BASE" {print $2}' /etc/ldap/ldap.conf 2>>/dev/null)
COOKIE=$(mktemp)

# Parameters given at runtime
USERNAME="$1"
USER_PASSWORD="$2"

# LDAP access
. /var/lib/eseriman/bin/ldapUser.sh

LDAP_OUTPUT=""
ldapSearchUser $LDAP_PASSWORD_LIBNSS "libnss" $USERNAME $LDAP_BASE "cn" LDAP_OUTPUT 
USER_FULL_NAME=$(echo "$LDAP_OUTPUT" | grep cn: | sed 's/^cn: \(.*\)$/\1/')

# Determine email address
# ldap was working above.  but to be absolutely safe again, we would need to loop as above. 
ALTERNATE_MAIL=$(ldapsearch -x -w "$LDAP_PASSWORD_LIBNSS" -D cn=libnss,ou=applications,ou=system,$LDAP_BASE uid=$USERNAME eseriMailAlternateAddress | grep eseriMailAlternateAddress: | sed 's/^eseriMailAlternateAddress: \(.*\)$/\1/')
if [ ${#ALTERNATE_MAIL} -gt 3 ] ; then
        EMAIL_ADDRESS=$ALTERNATE_MAIL
else
        EMAIL_ADDRESS="$USERNAME@$DOMAIN"
fi

# URL Encode variables
USER_FULL_NAME_ENCODED=$(echo "$USER_FULL_NAME" | awk -f $AWK_FOLDER/urlencode.awk)
USER_EMAIL_ENCODED=$(echo "$EMAIL_ADDRESS" | awk -f $AWK_FOLDER/urlencode.awk)
COMPANY_NAME_ENCODED=$(echo "$COMPANY_NAME" | awk -f $AWK_FOLDER/urlencode.awk)

DATE_TODAY=$(date +%m-%d-%Y)

# Encrypt default password
SQL_LEDGER_PASSWORD_ADMIN_ENCRYPTED=$(perl -e "print crypt '${SQL_LEDGER_PASSWORD_ADMIN}', 'ro';")

# Read actual encrypted password
SQL_LEDGER_PASSWORD_ADMIN_ACTUAL=$(awk -f $AWK_FOLDER/sql-ledger-members-read-password.awk -v PASSWORD="test" /var/lib/sql-ledger/users/members | awk 'BEGIN{FS="="} /password/ {print $2}')

# Set the SQL-Ledger root password to default if it is set to something else
if [ "$SQL_LEDGER_PASSWORD_ADMIN_ENCRYPTED" != "$SQL_LEDGER_PASSWORD_ADMIN_ACTUAL" ]; then
	awk -f $AWK_FOLDER/sql-ledger-members-set-password.awk -v PASSWORD="$SQL_LEDGER_PASSWORD_ADMIN_ENCRYPTED" /var/lib/sql-ledger/users/members >/var/lib/sql-ledger/users/members.tmp
	chown www-data:www-data /var/lib/sql-ledger/users/members.tmp
	mv /var/lib/sql-ledger/users/members.tmp /var/lib/sql-ledger/users/members
fi

function CURL {
	if [ ! -e $COOKIE ]; then
		curl -c $COOKIE -d "$2" http://sql-ledger.$DOMAIN/$1
	else
		curl -b $COOKIE -c $COOKIE -d "$2" http://sql-ledger.$DOMAIN/$1
	fi
}

# Login
D1="login=admin"
D1+="&password=${SQL_LEDGER_PASSWORD_ADMIN}"
D1+="&js=1"
D1+="&action=Login"
D1+="&path=bin%2Fmozilla"

CURL "login.pl" $D1

# Create user (superuser or regular)
#   The hidden inputs:
        D="login=admin@sql-ledger"
        D+="&precision=2"
        D+="&id="
        D+="&db=employee"
        D+="&addressid="
        D+="&path=bin%2Fmozilla"
        D+="&callback=hr.pl%3Faction%3Dadd%26db%3Demployee%26path%3Dbin%2Fmozilla%26login%3Dadmin@sql-ledger"

# the submit
        D+="&action=Save"

# hidden inputs, starting at the top:
        D+="&payrate_rows=1"
        D+="&wage_rows=1"
        D+="&deduction_rows=1"
        D+="&reference_rows=1"
        D+="&referenceurl="
        D+="&status="
        D+="&titlebar=Add%20Employee%20-%20SQL-Ledger%20Version%203.0.4%20-%20-%20sql-ledger"
        D+="&title=Add%20Employee"
        D+="&helpref="
        D+="&oldemployeelogin="
        D+="&oldemployeepassword="
        D+="&company=${COMPANY_NAME_ENCODED}"
        D+="&selectpaymentmethod="
        D+="&selectpayment=%0a1060--Chequing%20Account%0a1065--Petty%20Cash%0a"
        D+="&selectap=%0a2100--Accounts%20Payable%0a"
        D+="&selectwage="
        D+="&selectdeduction="
        D+="&selectacsrole="

# some visible fields:
        D+="&employeenumber="
        D+="&address1="
        D+="&address2="
        D+="&city="
        D+="&state="
        D+="&zipcode="
        D+="&country="
        D+="&email=${USER_EMAIL_ENCODED}"
        D+="&name=${USER_FULL_NAME_ENCODED}"
        D+="&employeelogin=${USERNAME}"
        D+="&employeepassword=${USER_PASSWORD}"
        D+="&workphone="
        D+="&workfax="
        D+="&workmobile="
        D+="&homephone="
        D+="&homemobile="
        D+="&startdate=${DATE_TODAY}"
        D+="&enddate="
        D+="&ssn="
        D+="&dob="
        D+="&notes="
        D+="&bankname="
        D+="&bankaddress1="
        D+="&bankaddress2="
        D+="&bankcity="
        D+="&bankstate="
        D+="&bankzipcode="
        D+="&bankcountry="
        D+="&iban="
        D+="&bic="
        D+="&membernumber="
        D+="&clearingnumber="
        D+="&referencedescription_1="
        D+="&referenceid_1="
        D+="&ap=2100--Accounts%20Payable"
        D+="&payment=1060--Chequing%20Account"
        D+="&payperiod="
        D+="&rate_1="

# what is this? above_2, above_3 get added as you use 'access control'
        D+="&above_1="

# when are these used?
        D+="&version=3.0.4"
        D+="&timeout=31557600"

# Access Control: let all users at these
        D+="&Version--Version=1"
        D+="&Preferences--Preferences=1"
        D+="&Logout--Logout=1"

if [ $(grep '^\[.*\]$' /var/lib/sql-ledger/users/members |wc -l) -gt 2 ]; then
    # Regular user

        ACS="AR--AR;"
          ACS+="AR--Add Transaction;"
          ACS+="AR--Sales Invoice;"
          ACS+="AR--Credit Note;"
          ACS+="AR--Credit Invoice;"
          ACS+="AR--Reports;"
          ACS+="AR--Reports--Transactions;"
          ACS+="AR--Reports--Outstanding;"
          ACS+="AR--Reports--AR Aging;"
          ACS+="AR--Reports--Reminder;"
          ACS+="AR--Reports--Tax collected;"
          ACS+="AR--Reports--Non-taxable;"
          ACS+="AR--Generate;"
          ACS+="AR--Generate--Sales Invoices;"
          ACS+="Customers--Customers;"
          ACS+="Customers--Add Customer;"
          ACS+="Customers--Reports;"
          ACS+="Customers--Reports--Search;"
          ACS+="Customers--Reports--History;"
          ACS+="AP--AP;"
          ACS+="AP--Add Transaction;"
          ACS+="AP--Vendor Invoice;"
          ACS+="AP--Debit Note;"
          ACS+="AP--Debit Invoice;"
          ACS+="AP--Reports;"
          ACS+="AP--Reports--Transactions;"
          ACS+="AP--Reports--Outstanding;"
          ACS+="AP--Reports--AP Aging;"
          ACS+="AP--Reports--Tax paid;"
          ACS+="AP--Reports--Non-taxable;"
          ACS+="Vendors--Vendors;"
          ACS+="Vendors--Add Vendor;"
          ACS+="Vendors--Reports;"
          ACS+="Vendors--Reports--Search;"
          ACS+="Vendors--Reports--History;"
          ACS+="Cash--Cash;"
          ACS+="Cash--Receipt;"
          ACS+="Cash--Receipts;"
          ACS+="Cash--Payment;"
          ACS+="Cash--Payments;"
          ACS+="Cash--FX Adjustment;"
          ACS+="Cash--Reconciliation;"
          ACS+="Cash--Reports;"
          ACS+="Cash--Reports--Receipts;"
          ACS+="Cash--Reports--Payments;"
          ACS+="Cash--Reports--Reconciliation;"
          ACS+="Vouchers--Vouchers;"
          ACS+="Vouchers--Payable;"
          ACS+="Vouchers--Payment;"
          ACS+="Vouchers--Payments;"
          ACS+="Vouchers--Payment Reversal;"
          ACS+="Vouchers--General Ledger;"
          ACS+="Vouchers--Reports;"
          ACS+="Vouchers--Reports--All Batches;"
          ACS+="Vouchers--Reports--Payable;"
          ACS+="Vouchers--Reports--Payment;"
          ACS+="Vouchers--Reports--Payment Reversal;"
          ACS+="Vouchers--Reports--General Ledger;"
          ACS+="HR--HR;"
          ACS+="HR--Employees;"
          ACS+="HR--Employees--Add Employee;"
          ACS+="HR--Employees--Reports;"
          ACS+="HR--Payroll;"
          ACS+="HR--Payroll--Add Transaction;"
          ACS+="HR--Payroll--Transactions;"
          ACS+="HR--Payroll--Setup;"
          ACS+="HR--Payroll--Setup--Wages;"
          ACS+="HR--Payroll--Setup--Deductions;"
          ACS+="Order Entry--Order Entry;"
          ACS+="Order Entry--Sales Order;"
          ACS+="Order Entry--Purchase Order;"
          ACS+="Order Entry--Reports;"
          ACS+="Order Entry--Reports--Sales Orders;"
          ACS+="Order Entry--Reports--Requirements;"
          ACS+="Order Entry--Reports--Purchase Orders;"
          ACS+="Order Entry--Generate;"
          ACS+="Order Entry--Generate--Purchase Orders;"
          ACS+="Order Entry--Consolidate;"
          ACS+="Order Entry--Consolidate--Sales Orders;"
          ACS+="Order Entry--Consolidate--Purchase Orders;"
          ACS+="Shipping--Shipping;"
          ACS+="Shipping--Ship;"
          ACS+="Shipping--Receive;"
          ACS+="Shipping--Transfer;"
          ACS+="Quotations--Quotations;"
          ACS+="Quotations--Quotation;"
          ACS+="Quotations--RFQ;"
          ACS+="Quotations--Reports;"
          ACS+="Quotations--Reports--Quotations;"
          ACS+="Quotations--Reports--RFQs;"
          ACS+="General Ledger--General Ledger;"
          ACS+="General Ledger--Add Transaction;"
          ACS+="General Ledger--Reports;"
          ACS+="Goods & Services--Goods & Services;"
          ACS+="Goods & Services--Add Part;"
          ACS+="Goods & Services--Add Service;"
          ACS+="Goods & Services--Add Assembly;"
          ACS+="Goods & Services--Add Labor/Overhead;"
          ACS+="Goods & Services--Add Group;"
          ACS+="Goods & Services--Add Pricegroup;"
          ACS+="Goods & Services--Stock Assembly;"
          ACS+="Goods & Services--Changeup;"
          ACS+="Goods & Services--Changeup--Assembly;"
          ACS+="Goods & Services--Changeup--Part;"
          ACS+="Goods & Services--Changeup--Service;"
          ACS+="Goods & Services--Changeup--Labor/Overhead;"
          ACS+="Goods & Services--Reports;"
          ACS+="Goods & Services--Reports--All Items;"
          ACS+="Goods & Services--Reports--Parts;"
          ACS+="Goods & Services--Reports--Requirements;"
          ACS+="Goods & Services--Reports--Services;"
          ACS+="Goods & Services--Reports--Labor/Overhead;"
          ACS+="Goods & Services--Reports--Groups;"
          ACS+="Goods & Services--Reports--Pricegroups;"
          ACS+="Goods & Services--Reports--Assemblies;"
          ACS+="Goods & Services--Reports--Components;"
          ACS+="Goods & Services--Translations;"
          ACS+="Goods & Services--Translations--Description;"
          ACS+="Goods & Services--Translations--Groups;"
          ACS+="Projects--Projects;"
          ACS+="Projects--Add Project;"
          ACS+="Projects--Add Time Card;"
          ACS+="Projects--Reports;"
          ACS+="Projects--Reports--Projects;"
          ACS+="Projects--Reports--Transactions;"
          ACS+="Projects--Reports--Time Cards;"
          ACS+="Projects--Generate;"
          ACS+="Projects--Generate--Sales Orders;"
          ACS+="Projects--Translations;"
          ACS+="Projects--Translations--Description;"
          ACS+="POS--Sale;"
          ACS+="POS--Receipts;"
          ACS+="POS--POS;"
          ACS+="POS--Open;"
          ACS+="Reports--Reports;"
          ACS+="Reports--Chart of Accounts;"
          ACS+="Reports--Trial Balance;"
          ACS+="Reports--Income Statement;"
          ACS+="Reports--Balance Sheet;"
          ACS+="Recurring Transactions--Recurring Transactions;"
          ACS+="Batch--Batch;"
          ACS+="Batch--Print;"
          ACS+="Batch--Print--Sales Invoices;"
          ACS+="Batch--Print--Remittance Vouchers;"
          ACS+="Batch--Print--Sales Orders;"
          ACS+="Batch--Print--Work Orders;"
          ACS+="Batch--Print--Quotations;"
          ACS+="Batch--Print--Packing Lists;"
          ACS+="Batch--Print--Pick Lists;"
          ACS+="Batch--Print--Vendor Invoices;"
          ACS+="Batch--Print--Purchase Orders;"
          ACS+="Batch--Print--Bin Lists;"
          ACS+="Batch--Print--RFQs;"
          ACS+="Batch--Print--Time Cards;"
          ACS+="Batch--Email;"
          ACS+="Batch--Email--Sales Invoices;"
          ACS+="Batch--Email--Remittance Vouchers;"
          ACS+="Batch--Email--Sales Orders;"
          ACS+="Batch--Email--Work Orders;"
          ACS+="Batch--Email--Quotations;"
          ACS+="Batch--Email--Packing Lists;"
          ACS+="Batch--Email--Pick Lists;"
          ACS+="Batch--Email--Vendor Invoices;"
          ACS+="Batch--Email--Purchase Orders;"
          ACS+="Batch--Email--Bin Lists;"
          ACS+="Batch--Email--RFQs;"
          ACS+="Batch--Queue;"
          ACS+="Batch--Queue--Sales Invoices;"
          ACS+="Batch--Queue--Remittance Vouchers;"
          ACS+="Batch--Queue--Sales Orders;"
          ACS+="Batch--Queue--Work Orders;"
          ACS+="Batch--Queue--Quotations;"
          ACS+="Batch--Queue--Packing Lists;"
          ACS+="Batch--Queue--Pick Lists;"
          ACS+="Batch--Queue--Vendor Invoices;"
          ACS+="Batch--Queue--Purchase Orders;"
          ACS+="Batch--Queue--Bin Lists;"
          ACS+="Batch--Queue--RFQs;"
          ACS+="Batch--Queue--Time Cards;"
          ACS+="Exchange Rates--Exchange Rates;"
          ACS+="Import--Import;"
          ACS+="Import--Customers;"
          ACS+="Import--Vendors;"
          ACS+="Import--Parts;"
          ACS+="Import--Services;"
          ACS+="Import--Labor/Overhead;"
          ACS+="Import--Sales Invoices;"
          ACS+="Import--Groups;"
          ACS+="Import--Payments;"
          ACS+="Import--Sales Orders;"
          ACS+="Import--Purchase Orders;"
          ACS+="Import--Chart of Accounts;"
          ACS+="Export--Export;"
          ACS+="Export--Payments;"
          ACS+="System--System;"
          ACS+="System--Defaults;"
          ACS+="System--Audit Control;"
          ACS+="System--Bank Accounts;"
          ACS+="System--Taxes;"
          ACS+="System--Currencies;"
          ACS+="System--Payment Methods;"
          ACS+="System--Workstations;"
          ACS+="System--Roles;"
          ACS+="System--Warehouses;"
          ACS+="System--Departments;"
          ACS+="System--Type of Business;"
          ACS+="System--Language;"
          ACS+="System--SIC;"
          ACS+="System--Yearend;"
          ACS+="System--Maintenance;"
          ACS+="System--Maintenance--Delete Invoices;"
          ACS+="System--Maintenance--Repost Invoices;"
          ACS+="System--Maintenance--Mapfile;"
          ACS+="System--Maintenance--Clear Semaphores;"
          ACS+="System--Maintenance--Lock Dataset;"
          ACS+="System--Maintenance--Unlock Dataset;"
          ACS+="System--Maintenance--Restore;"
          ACS+="System--Maintenance--Monitor;"
          ACS+="System--Backup;"
          ACS+="System--Backup--Send by E-Mail;"
          ACS+="System--Backup--Save to File;"
          ACS+="System--Chart of Accounts;"
          ACS+="System--Chart of Accounts--Add Account;"
          ACS+="System--Chart of Accounts--List Accounts;"
          ACS+="System--Chart of Accounts--Translations;"
          ACS+="System--Chart of Accounts--Add GIFI;"
          ACS+="System--Chart of Accounts--List GIFI;"
          ACS+="System--html Templates;"
          ACS+="System--html Templates--Income Statement;"
          ACS+="System--html Templates--Balance Sheet;"
          ACS+="System--html Templates--Sales Invoice;"
          ACS+="System--html Templates--Credit Invoice;"
          ACS+="System--html Templates--Vendor Invoice;"
          ACS+="System--html Templates--Debit Invoice;"
          ACS+="System--html Templates--AR Transaction;"
          ACS+="System--html Templates--AP Transaction;"
          ACS+="System--html Templates--Credit Note;"
          ACS+="System--html Templates--Debit Note;"
          ACS+="System--html Templates--Remittance Voucher;"
          ACS+="System--html Templates--Packing List;"
          ACS+="System--html Templates--Pick List;"
          ACS+="System--html Templates--Sales Order;"
          ACS+="System--html Templates--Work Order;"
          ACS+="System--html Templates--Purchase Order;"
          ACS+="System--html Templates--Bin List;"
          ACS+="System--html Templates--Statement;"
          ACS+="System--html Templates--1.Reminder;"
          ACS+="System--html Templates--2.Reminder;"
          ACS+="System--html Templates--3.Reminder;"
          ACS+="System--html Templates--Check;"
          ACS+="System--html Templates--Receipt;"
          ACS+="System--html Templates--Quotation;"
          ACS+="System--html Templates--RFQ;"
          ACS+="System--html Templates--Time Card;"
          ACS+="System--html Templates--Payslip;"
          ACS+="System--XML Templates;"
          ACS+="System--XML Templates--Sales Invoice;"
          ACS+="System--XML Templates--Credit Invoice;"
          ACS+="System--XML Templates--Vendor Invoice;"
          ACS+="System--XML Templates--Debit Invoice;"
          ACS+="System--XML Templates--AR Transaction;"
          ACS+="System--XML Templates--AP Transaction;"
          ACS+="System--XML Templates--Credit Note;"
          ACS+="System--XML Templates--Debit Note;"
          ACS+="System--XML Templates--Remittance Voucher;"
          ACS+="System--XML Templates--Packing List;"
          ACS+="System--XML Templates--Pick List;"
          ACS+="System--XML Templates--Sales Order;"
          ACS+="System--XML Templates--Work Order;"
          ACS+="System--XML Templates--Purchase Order;"
          ACS+="System--XML Templates--Bin List;"
          ACS+="System--XML Templates--Statement;"
          ACS+="System--XML Templates--1.Reminder;"
          ACS+="System--XML Templates--2.Reminder;"
          ACS+="System--XML Templates--3.Reminder;"
          ACS+="System--XML Templates--Check;"
          ACS+="System--XML Templates--Receipt;"
          ACS+="System--XML Templates--Quotation;"
          ACS+="System--XML Templates--RFQ;"
          ACS+="System--XML Templates--Time Card;"
          ACS+="System--XML Templates--Payslip;"
          ACS+="System--LaTeX Templates;"
          ACS+="System--LaTeX Templates--Sales Invoice;"
          ACS+="System--LaTeX Templates--Credit Invoice;"
          ACS+="System--LaTeX Templates--Vendor Invoice;"
          ACS+="System--LaTeX Templates--Debit Invoice;"
          ACS+="System--LaTeX Templates--AR Transaction;"
          ACS+="System--LaTeX Templates--AP Transaction;"
          ACS+="System--LaTeX Templates--Credit Note;"
          ACS+="System--LaTeX Templates--Debit Note;"
          ACS+="System--LaTeX Templates--Remittance Voucher;"
          ACS+="System--LaTeX Templates--Packing List;"
          ACS+="System--LaTeX Templates--Pick List;"
          ACS+="System--LaTeX Templates--Sales Order;"
          ACS+="System--LaTeX Templates--Work Order;"
          ACS+="System--LaTeX Templates--Purchase Order;"
          ACS+="System--LaTeX Templates--Bin List;"
          ACS+="System--LaTeX Templates--Statement;"
          ACS+="System--LaTeX Templates--1.Reminder;"
          ACS+="System--LaTeX Templates--2.Reminder;"
          ACS+="System--LaTeX Templates--3.Reminder;"
          ACS+="System--LaTeX Templates--Check;"
          ACS+="System--LaTeX Templates--Receipt;"
          ACS+="System--LaTeX Templates--Quotation;"
          ACS+="System--LaTeX Templates--RFQ;"
          ACS+="System--LaTeX Templates--Time Card;"
          ACS+="System--LaTeX Templates--Barcode;"
          ACS+="System--LaTeX Templates--Payslip;"
          ACS+="System--Text Templates;"
          ACS+="System--Text Templates--POS Invoice;"
          ACS+="System--Text Templates--Sales Invoice;"
          ACS+="System--Text Templates--Credit Invoice;"
          ACS+="System--Text Templates--Vendor Invoice;"
          ACS+="System--Text Templates--Debit Invoice;"
          ACS+="System--Text Templates--AR Transaction;"
          ACS+="System--Text Templates--AP Transaction;"
          ACS+="System--Text Templates--Credit Note;"
          ACS+="System--Text Templates--Debit Note;"
          ACS+="System--Text Templates--Remittance Voucher;"
          ACS+="System--Text Templates--Packing List;"
          ACS+="System--Text Templates--Pick List;"
          ACS+="System--Text Templates--Sales Order;"
          ACS+="System--Text Templates--Work Order;"
          ACS+="System--Text Templates--Purchase Order;"
          ACS+="System--Text Templates--Bin List;"
          ACS+="System--Text Templates--Statement;"
          ACS+="System--Text Templates--1.Reminder;"
          ACS+="System--Text Templates--2.Reminder;"
          ACS+="System--Text Templates--3.Reminder;"
          ACS+="System--Text Templates--Check;"
          ACS+="System--Text Templates--Receipt;"
          ACS+="System--Text Templates--Quotation;"
          ACS+="System--Text Templates--RFQ;"
          ACS+="System--Text Templates--Time Card;"
          ACS+="System--Text Templates--Payslip;"
          ACS+="Stylesheet--Stylesheet;"

	ACS_ENCODED=$(echo "$ACS" | awk -f $AWK_FOLDER/urlencode.awk)
        D+="&acs="          
        D+=$ACS_ENCODED          
else
    # super user
        D+="&acs="
        D+="&Vouchers--Vouchers=1"
        D+="&Vouchers--Reports--Payment%20Reversal=1"
        D+="&Vouchers--Reports--Payment=1"
        D+="&Vouchers--Reports--Payable=1"
        D+="&Vouchers--Reports--General%20Ledger=1"
        D+="&Vouchers--Reports--All%20Batches=1"
        D+="&Vouchers--Reports=1"
        D+="&Vouchers--Payments=1"
        D+="&Vouchers--Payment%20Reversal=1"
        D+="&Vouchers--Payment=1"
        D+="&Vouchers--Payable=1"
        D+="&Vouchers--General%20Ledger=1"
        D+="&Vendors--Vendors=1"
        D+="&Vendors--Reports--Search=1"
        D+="&Vendors--Reports--History=1"
        D+="&Vendors--Reports=1"
        D+="&Vendors--Add%20Vendor=1"
        D+="&System--Yearend=1"
        D+="&System--XML%20Templates--Work%20Order=1"
        D+="&System--XML%20Templates--Vendor%20Invoice=1"
        D+="&System--XML%20Templates--Time%20Card=1"
        D+="&System--XML%20Templates--Statement=1"
        D+="&System--XML%20Templates--Sales%20Order=1"
        D+="&System--XML%20Templates--Sales%20Invoice=1"
        D+="&System--XML%20Templates--RFQ=1"
        D+="&System--XML%20Templates--Remittance%20Voucher=1"
        D+="&System--XML%20Templates--Receipt=1"
        D+="&System--XML%20Templates--Quotation=1"
        D+="&System--XML%20Templates--Purchase%20Order=1"
        D+="&System--XML%20Templates--Pick%20List=1"
        D+="&System--XML%20Templates--Payslip=1"
        D+="&System--XML%20Templates--Packing%20List=1"
        D+="&System--XML%20Templates--Debit%20Note=1"
        D+="&System--XML%20Templates--Debit%20Invoice=1"
        D+="&System--XML%20Templates--Credit%20Note=1"
        D+="&System--XML%20Templates--Credit%20Invoice=1"
        D+="&System--XML%20Templates--Check=1"
        D+="&System--XML%20Templates--Bin%20List=1"
        D+="&System--XML%20Templates--AR%20Transaction=1"
        D+="&System--XML%20Templates--AP%20Transaction=1"
        D+="&System--XML%20Templates--3.Reminder=1"
        D+="&System--XML%20Templates--2.Reminder=1"
        D+="&System--XML%20Templates--1.Reminder=1"
        D+="&System--XML%20Templates=1"
        D+="&System--Workstations=1"
        D+="&System--Warehouses=1"
        D+="&System--Type%20of%20Business=1"
        D+="&System--Text%20Templates--Work%20Order=1"
        D+="&System--Text%20Templates--Vendor%20Invoice=1"
        D+="&System--Text%20Templates--Time%20Card=1"
        D+="&System--Text%20Templates--Statement=1"
        D+="&System--Text%20Templates--Sales%20Order=1"
        D+="&System--Text%20Templates--Sales%20Invoice=1"
        D+="&System--Text%20Templates--RFQ=1"
        D+="&System--Text%20Templates--Remittance%20Voucher=1"
        D+="&System--Text%20Templates--Receipt=1"
        D+="&System--Text%20Templates--Quotation=1"
        D+="&System--Text%20Templates--Purchase%20Order=1"
        D+="&System--Text%20Templates--POS%20Invoice=1"
        D+="&System--Text%20Templates--Pick%20List=1"
        D+="&System--Text%20Templates--Payslip=1"
        D+="&System--Text%20Templates--Packing%20List=1"
        D+="&System--Text%20Templates--Debit%20Note=1"
        D+="&System--Text%20Templates--Debit%20Invoice=1"
        D+="&System--Text%20Templates--Credit%20Note=1"
        D+="&System--Text%20Templates--Credit%20Invoice=1"
        D+="&System--Text%20Templates--Check=1"
        D+="&System--Text%20Templates--Bin%20List=1"
        D+="&System--Text%20Templates--AR%20Transaction=1"
        D+="&System--Text%20Templates--AP%20Transaction=1"
        D+="&System--Text%20Templates--3.Reminder=1"
        D+="&System--Text%20Templates--2.Reminder=1"
        D+="&System--Text%20Templates--1.Reminder=1"
        D+="&System--Text%20Templates=1"
        D+="&System--Taxes=1"
        D+="&System--System=1"
        D+="&System--SIC=1"
        D+="&System--Roles=1"
        D+="&System--Payment%20Methods=1"
        D+="&System--Maintenance--Unlock%20Dataset=1"
        D+="&System--Maintenance--Restore=1"
        D+="&System--Maintenance--Repost%20Invoices=1"
        D+="&System--Maintenance--Monitor=1"
        D+="&System--Maintenance--Mapfile=1"
        D+="&System--Maintenance--Lock%20Dataset=1"
        D+="&System--Maintenance--Delete%20Invoices=1"
        D+="&System--Maintenance--Clear%20Semaphores=1"
        D+="&System--Maintenance=1"
        D+="&System--LaTeX%20Templates--Work%20Order=1"
        D+="&System--LaTeX%20Templates--Vendor%20Invoice=1"
        D+="&System--LaTeX%20Templates--Time%20Card=1"
        D+="&System--LaTeX%20Templates--Statement=1"
        D+="&System--LaTeX%20Templates--Sales%20Order=1"
        D+="&System--LaTeX%20Templates--Sales%20Invoice=1"
        D+="&System--LaTeX%20Templates--RFQ=1"
        D+="&System--LaTeX%20Templates--Remittance%20Voucher=1"
        D+="&System--LaTeX%20Templates--Receipt=1"
        D+="&System--LaTeX%20Templates--Quotation=1"
        D+="&System--LaTeX%20Templates--Purchase%20Order=1"
        D+="&System--LaTeX%20Templates--Pick%20List=1"
        D+="&System--LaTeX%20Templates--Payslip=1"
        D+="&System--LaTeX%20Templates--Packing%20List=1"
        D+="&System--LaTeX%20Templates--Debit%20Note=1"
        D+="&System--LaTeX%20Templates--Debit%20Invoice=1"
        D+="&System--LaTeX%20Templates--Credit%20Note=1"
        D+="&System--LaTeX%20Templates--Credit%20Invoice=1"
        D+="&System--LaTeX%20Templates--Check=1"
        D+="&System--LaTeX%20Templates--Bin%20List=1"
        D+="&System--LaTeX%20Templates--Barcode=1"
        D+="&System--LaTeX%20Templates--AR%20Transaction=1"
        D+="&System--LaTeX%20Templates--AP%20Transaction=1"
        D+="&System--LaTeX%20Templates--3.Reminder=1"
        D+="&System--LaTeX%20Templates--2.Reminder=1"
        D+="&System--LaTeX%20Templates--1.Reminder=1"
        D+="&System--LaTeX%20Templates=1"
        D+="&System--Language=1"
        D+="&System--html%20Templates--Work%20Order=1"
        D+="&System--html%20Templates--Vendor%20Invoice=1"
        D+="&System--html%20Templates--Time%20Card=1"
        D+="&System--html%20Templates--Statement=1"
        D+="&System--html%20Templates--Sales%20Order=1"
        D+="&System--html%20Templates--Sales%20Invoice=1"
        D+="&System--html%20Templates--RFQ=1"
        D+="&System--html%20Templates--Remittance%20Voucher=1"
        D+="&System--html%20Templates--Receipt=1"
        D+="&System--html%20Templates--Quotation=1"
        D+="&System--html%20Templates--Purchase%20Order=1"
        D+="&System--html%20Templates--Pick%20List=1"
        D+="&System--html%20Templates--Payslip=1"
        D+="&System--html%20Templates--Packing%20List=1"
        D+="&System--html%20Templates--Income%20Statement=1"
        D+="&System--html%20Templates--Debit%20Note=1"
        D+="&System--html%20Templates--Debit%20Invoice=1"
        D+="&System--html%20Templates--Credit%20Note=1"
        D+="&System--html%20Templates--Credit%20Invoice=1"
        D+="&System--html%20Templates--Check=1"
        D+="&System--html%20Templates--Bin%20List=1"
        D+="&System--html%20Templates--Balance%20Sheet=1"
        D+="&System--html%20Templates--AR%20Transaction=1"
        D+="&System--html%20Templates--AP%20Transaction=1"
        D+="&System--html%20Templates--3.Reminder=1"
        D+="&System--html%20Templates--2.Reminder=1"
        D+="&System--html%20Templates--1.Reminder=1"
        D+="&System--html%20Templates=1"
        D+="&System--Departments=1"
        D+="&System--Defaults=1"
        D+="&System--Currencies=1"
        D+="&System--Chart%20of%20Accounts--Translations=1"
        D+="&System--Chart%20of%20Accounts--List%20GIFI=1"
        D+="&System--Chart%20of%20Accounts--List%20Accounts=1"
        D+="&System--Chart%20of%20Accounts--Add%20GIFI=1"
        D+="&System--Chart%20of%20Accounts--Add%20Account=1"
        D+="&System--Chart%20of%20Accounts=1"
        D+="&System--Bank%20Accounts=1"
        D+="&System--Backup--Send%20by%20E-Mail=1"
        D+="&System--Backup--Save%20to%20File=1"
        D+="&System--Backup=1"
        D+="&System--Audit%20Control=1"
        D+="&Stylesheet--Stylesheet=1"
        D+="&stylesheet=sql-ledger.css"
        D+="&Shipping--Transfer=1"
        D+="&Shipping--Shipping=1"
        D+="&Shipping--Ship=1"
        D+="&Shipping--Receive=1"
        D+="&Reports--Trial%20Balance=1"
        D+="&Reports--Reports=1"
        D+="&Reports--Income%20Statement=1"
        D+="&Reports--Chart%20of%20Accounts=1"
        D+="&Reports--Balance%20Sheet=1"
        D+="&Recurring%20Transactions--Recurring%20Transactions=1"
        D+="&Quotations--RFQ=1"
        D+="&Quotations--Reports--RFQs=1"
        D+="&Quotations--Reports--Quotations=1"
        D+="&Quotations--Reports=1"
        D+="&Quotations--Quotations=1"
        D+="&Quotations--Quotation=1"
        D+="&Projects--Translations--Description=1"
        D+="&Projects--Translations=1"
        D+="&Projects--Reports--Transactions=1"
        D+="&Projects--Reports--Time%20Cards=1"
        D+="&Projects--Reports--Projects=1"
        D+="&Projects--Reports=1"
        D+="&Projects--Projects=1"
        D+="&Projects--Generate--Sales%20Orders=1"
        D+="&Projects--Generate=1"
        D+="&Projects--Add%20Time%20Card=1"
        D+="&Projects--Add%20Project=1"
        D+="&POS--Sale=1"
        D+="&POS--Receipts=1"
        D+="&POS--POS=1"
        D+="&POS--Open=1"
        D+="&Order%20Entry--Sales%20Order=1"
        D+="&Order%20Entry--Reports--Sales%20Orders=1"
        D+="&Order%20Entry--Reports--Requirements=1"
        D+="&Order%20Entry--Reports--Purchase%20Orders=1"
        D+="&Order%20Entry--Reports=1"
        D+="&Order%20Entry--Purchase%20Order=1"
        D+="&Order%20Entry--Order%20Entry=1"
        D+="&Order%20Entry--Generate--Purchase%20Orders=1"
        D+="&Order%20Entry--Generate=1"
        D+="&Order%20Entry--Consolidate--Sales%20Orders=1"
        D+="&Order%20Entry--Consolidate--Purchase%20Orders=1"
        D+="&Order%20Entry--Consolidate=1"
        D+="&Import--Vendors=1"
        D+="&Import--Services=1"
        D+="&Import--Sales%20Orders=1"
        D+="&Import--Sales%20Invoices=1"
        D+="&Import--Purchase%20Orders=1"
        D+="&Import--Payments=1"
        D+="&Import--Parts=1"
        D+="&Import--Labor%2fOverhead=1"
        D+="&Import--Import=1"
        D+="&Import--Groups=1"
        D+="&Import--Customers=1"
        D+="&Import--Chart%20of%20Accounts=1"
        D+="&HR--Payroll--Transactions=1"
        D+="&HR--Payroll--Setup--Wages=1"
        D+="&HR--Payroll--Setup--Deductions=1"
        D+="&HR--Payroll--Setup=1"
        D+="&HR--Payroll--Add%20Transaction=1"
        D+="&HR--Payroll=1"
        D+="&HR--HR=1"
        D+="&HR--Employees--Reports=1"
        D+="&HR--Employees--Add%20Employee=1"
        D+="&HR--Employees=1"
        D+="&Goods%20%26%20Services--Translations--Groups=1"
        D+="&Goods%20%26%20Services--Translations--Description=1"
        D+="&Goods%20%26%20Services--Translations=1"
        D+="&Goods%20%26%20Services--Stock%20Assembly=1"
        D+="&Goods%20%26%20Services--Reports--Services=1"
        D+="&Goods%20%26%20Services--Reports--Requirements=1"
        D+="&Goods%20%26%20Services--Reports--Pricegroups=1"
        D+="&Goods%20%26%20Services--Reports--Parts=1"
        D+="&Goods%20%26%20Services--Reports--Labor%2fOverhead=1"
        D+="&Goods%20%26%20Services--Reports--Groups=1"
        D+="&Goods%20%26%20Services--Reports--Components=1"
        D+="&Goods%20%26%20Services--Reports--Assemblies=1"
        D+="&Goods%20%26%20Services--Reports--All%20Items=1"
        D+="&Goods%20%26%20Services--Reports=1"
        D+="&Goods%20%26%20Services--Goods%20%26%20Services=1"
        D+="&Goods%20%26%20Services--Changeup--Service=1"
        D+="&Goods%20%26%20Services--Changeup--Part=1"
        D+="&Goods%20%26%20Services--Changeup--Labor%2fOverhead=1"
        D+="&Goods%20%26%20Services--Changeup--Assembly=1"
        D+="&Goods%20%26%20Services--Changeup=1"
        D+="&Goods%20%26%20Services--Add%20Service=1"
        D+="&Goods%20%26%20Services--Add%20Pricegroup=1"
        D+="&Goods%20%26%20Services--Add%20Part=1"
        D+="&Goods%20%26%20Services--Add%20Labor%2fOverhead=1"
        D+="&Goods%20%26%20Services--Add%20Group=1"
        D+="&Goods%20%26%20Services--Add%20Assembly=1"
        D+="&General%20Ledger--Reports=1"
        D+="&General%20Ledger--General%20Ledger=1"
        D+="&General%20Ledger--Add%20Transaction=1"
        D+="&Export--Payments=1"
        D+="&Export--Export=1"
        D+="&Exchange%20Rates--Exchange%20Rates=1"
        D+="&Customers--Reports--History=1"
        D+="&Customers--Reports=1"
        D+="&Customers--Customers=1"
        D+="&Customers--Add%20Customer=1"
        D+="&Cash--Reports--Reconciliation=1"
        D+="&Cash--Reports--Receipts=1"
        D+="&Cash--Reports--Payments=1"
        D+="&Cash--Reports=1"
        D+="&Cash--Reconciliation=1"
        D+="&Cash--Receipts=1"
        D+="&Cash--Receipt=1"
        D+="&Cash--Payments=1"
        D+="&Cash--Payment=1"
        D+="&Cash--FX%20Adjustment=1"
        D+="&Cash--Cash=1"
        D+="&Batch--Queue--Work%20Orders=1"
        D+="&Batch--Queue--Vendor%20Invoices=1"
        D+="&Batch--Queue--Time%20Cards=1"
        D+="&Batch--Queue--Sales%20Orders=1"
        D+="&Batch--Queue--Sales%20Invoices=1"
        D+="&Batch--Queue--RFQs=1"
        D+="&Batch--Queue--Remittance%20Vouchers=1"
        D+="&Batch--Queue--Quotations=1"
        D+="&Batch--Queue--Purchase%20Orders=1"
        D+="&Batch--Queue--Pick%20Lists=1"
        D+="&Batch--Queue--Packing%20Lists=1"
        D+="&Batch--Queue--Bin%20Lists=1"
        D+="&Batch--Queue=1"
        D+="&Batch--Print--Work%20Orders=1"
        D+="&Batch--Print--Vendor%20Invoices=1"
        D+="&Batch--Print--Time%20Cards=1"
        D+="&Batch--Print--Sales%20Orders=1"
        D+="&Batch--Print--Sales%20Invoices=1"
        D+="&Batch--Print--RFQs=1"
        D+="&Batch--Print--Remittance%20Vouchers=1"
        D+="&Batch--Print--Quotations=1"
        D+="&Batch--Print--Purchase%20Orders=1"
        D+="&Batch--Print--Pick%20Lists=1"
        D+="&Batch--Print--Packing%20Lists=1"
        D+="&Batch--Print--Bin%20Lists=1"
        D+="&Batch--Print=1"
        D+="&Batch--Email--Work%20Orders=1"
        D+="&Batch--Email--Vendor%20Invoices=1"
        D+="&Batch--Email--Sales%20Orders=1"
        D+="&Batch--Email--Sales%20Invoices=1"
        D+="&Batch--Email--RFQs=1"
        D+="&Batch--Email--Remittance%20Vouchers=1"
        D+="&Batch--Email--Quotations=1"
        D+="&Batch--Email--Purchase%20Orders=1"
        D+="&Batch--Email--Pick%20Lists=1"
        D+="&Batch--Email--Packing%20Lists=1"
        D+="&Batch--Email--Bin%20Lists=1"
        D+="&Batch--Email=1"
        D+="&Batch--Batch=1"
        D+="&AR--Sales%20Invoice=1"
        D+="&AR--Reports--Transactions=1"
        D+="&AR--Reports--Tax%20collected=1"
        D+="&AR--Reports--Reminder=1"
        D+="&AR--Reports--Outstanding=1"
        D+="&AR--Reports--Non-taxable=1"
        D+="&AR--Reports--AR%20Aging=1"
        D+="&AR--Reports=1"
        D+="&AR--Generate--Sales%20Invoices=1"
        D+="&AR--Generate=1"
        D+="&AR--Credit%20Note=1"
        D+="&AR--Credit%20Invoice=1"
        D+="&AR--AR=1"
        D+="&AR--Add%20Transaction=1"
        D+="&AP--Vendor%20Invoice=1"
        D+="&AP--Reports--Transactions=1"
        D+="&AP--Reports--Tax%20paid=1"
        D+="&AP--Reports--Outstanding=1"
        D+="&AP--Reports--Non-taxable=1"
        D+="&AP--Reports--AP%20Aging=1"
        D+="&AP--Reports=1"
        D+="&AP--Debit%20Note=1"
        D+="&AP--Debit%20Invoice=1"
        D+="&AP--AP=1"
        D+="&AP--Add%20Transaction=1"
fi

CURL "hr.pl" $D

# Set back the password if it was set to something else than the default
if [ "$SQL_LEDGER_PASSWORD_ADMIN_ENCRYPTED" != "$SQL_LEDGER_PASSWORD_ADMIN_ACTUAL" ]; then
	awk -f $AWK_FOLDER/sql-ledger-members-set-password.awk -v PASSWORD="$SQL_LEDGER_PASSWORD_ADMIN_ACTUAL" /var/lib/sql-ledger/users/members >/var/lib/sql-ledger/users/members.tmp
	chown www-data:www-data /var/lib/sql-ledger/users/members.tmp
	mv /var/lib/sql-ledger/users/members.tmp /var/lib/sql-ledger/users/members
fi

# Clean up
rm -f $COOKIE

exit 0
